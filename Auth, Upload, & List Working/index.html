<html>
<head><title>BabySAFE API</title>


<link rel="stylesheet" href="bootstrap.min.css">
<script src="jquery.min.js"></script>
<script src="bootstrap.min.js"></script>

</head>

<body>

<h1>BabySAFE API</h1>

<div style="float:left;margin:40px;">
    <h2>Authorize</h2>
    <input type="submit" value="AUTHORIZE" onclick="authorise()" />&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<button onclick = "isAuthorised()">CHECK AUTHORIZATION</button><br><br><button onclick = "removeAuthorization()">REMOVE AUTHORIZATION (Logout)</button><br><br>
    <b id = "auth-status">Not Authorized</b>
</div>



<div style="float:left;margin:40px;">
    <h2>Uploading Files</h2>
    <h3>Upload Public File</h3>
    <input type="file" id = "file" /><br><br><button id = "file-upload-button">UPLOAD FILE</button><br><br>
    <h3>Upload Private File</h3>
    <input type="file" /><br><br><button>UPLOAD FILE</button><br><br>
    <h3>Upload Text String</h3>
    <input type="text" value="Enter String..." size="11" /><br><br><button>UPLOAD TEXT STRING</button><br><br>
</div>

<div style="float:left;margin:40px;">
    <h2>Display Uploaded Files</h2>
    Displays <b>Images, Video, Audio,<br> Text Strings, & maybe Documents?</b> <br>(Needs to actually display the files / images <br>though, not just their names. *See VJ's Code)</b><br><br>
    <button id = "btn-file-list">Click to Display Files</button><br>
    <div id = "div-files"></div>
</div>

<div style="float:left;margin:40px;">
    <h2>Messages (Text)</h2>

    <h3>Private Message</h3>
    <input type="text" placeholder="Enter Message..." size="13" /> <input type="text" placeholder="Enter Recipient's ID..." size="17" /> <input type="submit" value="Send Message" /><br><br>
    <b>RECEIVED MESSAGES SHOW UP HERE</b><br><br>
    <h3>General, public chatroom message</h3>
    <input type="text" placeholder="Enter Message..." size="13" /> <input type="submit" value="Send Message" /><br><br>
    <b>ALL PUBLIC MESSAGES SHOW UP HERE</b>
</div>



<div style="float:left;margin:40px;">
  <h2>File Operations (NFS)</h2>
  <h3>Create Folder</h3>
  <input type="text" placeholder="Enter Folder Name..." /> <input type="submit" value="Create Folder" /><br><br>
  <h4>Create ID</h3>
  <input type="text" placeholder="Enter Desired ID..." /> <input type="submit" value="Claim ID" /><br><br>
  <h4>Create URL</h3>
  <input type="text" placeholder="Enter Desired URL..." /> <input type="submit" value="Map the URL..." /><br><br>
</div>



<br><br><br>


  <script>
      var authStatusText = document.getElementById('auth-status');
      var appHandle = null;
      var authUri = null;
      var Container = "apps/will";

      window.document.getElementById("btn-file-list").addEventListener("click", function() {
        showfiles();
      });
      
      window.document.getElementById("file-upload-button").addEventListener("click", function() {
        uploadfile();
      });
            
  
      window.onload = function() {
          //document.getElementById('buttonz').style.display = 'none';
      };

    
      function uploadMD() {
        // document.getElementById('buttonz').style.display="block";
        var content = document.getElementById('mdContent').value;
        window.safeMutableData.newRandomPublic(window.auth, 15001)
        .then(mdHandle => window.safeMutableData.quickSetup(mdHandle, {key1: content}))
        .then(mdHandle => {
          window.safeMutableData.get(mdHandle, 'key1')
          .then(value => {
            var utfString = String.fromCharCode.apply(null, new Uint8Array(value.buf));
            var parEl = document.getElementById('output');
            var childEl = document.createElement('div');
            childEl.textContent = utfString;
            parEl.appendChild(childEl);
          })
        })
      }
    

      //initialises and authorises with the network
      function authorise() {
        if (appHandle) {
          authStatusText.textContent = "Already Authorized";
          return;
        }

        var app = {
          id: "will",
          name: "WebApp Test",          
          vendor: 'MaidSafe Ltd.',
        };

        var permissions = {
          '_public': [
            'Read',
            'Insert',
            'Update',
            'Delete',
            'ManagePermissions'
          ],
          '_publicNames': [
            'Read',
            'Insert',
            'Update',
            'Delete',
            'ManagePermissions'
          ]
        };

        var owncontainer = {
          own_container: true
        };


        window.safeApp.initialise(app)
          .then((res) => {            
            appHandle = res;
            console.log("App Token: " + res);

            window.safeApp.authorise(appHandle, permissions, owncontainer)
              .then((res) => {
                authUri = res;
                authStatusText.textContent = "Authorized";
                console.log('App was authorised and auth URI received: ' + res);                
                
                window.safeApp.connectAuthorised(appHandle, authUri)
                  .then((appHandle) => {
                    console.log('The app was authorised and a session was created with the network. App token returned: ' + appHandle);
                    window.auth = appHandle;
                    
                    // window.safeMutableData.newRandomPublic(appHandle, 15002)
                    //       .then((res) => {
                    //         mdHandle = res;
                    //         console.log("Dir = " + 'Returns handle to newly created, public, randomly named MutableData structure: ' + res);
                    //         return 'Returns handle to newly created, public, randomly named MutableData structure: ' + res;
                    //       });

                    // window.safeMutableData.newPermissions(appHandle)
                    //       .then((res) => {
                    //         permsHandle = res;
                    //         return 'Newly created permissions handle returned: ' + res;
                    //       });

                    // window.safeMutableData.newPermissionSet(appHandle)
                    //       .then((res) => {
                    //         permSetHandle = res;
                    //         return 'Returns newly created PermissionsSet handle: ' + res;
                    //       });

                    // window.safeMutableData.newEntries(appHandle)
                    //       .then((res) => {
                    //         entriesHandle = res;
                    //         return 'Returns an entries handle to be used with safeMutableDataEntries functions: ' + res;
                    //       });

                    // window.safeMutableDataPermissionsSet.setAllow(permSetHandle, "Insert")
                    //       .then(() => window.safeMutableDataPermissionsSet.setAllow(permSetHandle, "Update"))
                    //       .then(() => window.safeMutableDataPermissionsSet.setAllow(permSetHandle, "Delete"))

                    // window.safeCrypto.getAppPubSignKey(appHandle)
                    //       .then((res) => {
                    //         signKeyHandle = res;

                    //         return 'Returns applications public signing key: ' + res;
                    //       });
                   
                    // window.safeMutableDataPermissions.insertPermissionsSet(permsHandle, signKeyHandle, permSetHandle)
                    //       .then(_ => {
                    //         return 'Finished inserting new permissions';
                    //       });




                  });
              });
          }, (err) => {
            console.error(err);
          });
      }

      function isAuthorised() {       
        if (appHandle) {
          authStatusText.textContent = "Authorized";
          //console.log('Authorized');
        }
        else {
          authStatusText.textContent = "Not Authorized";
          //console.log('Not Authorized');
        }  
      }

      function removeAuthorization() {
        window.safeApp.free(appHandle);
        appHandle = null;
        authUri = null;
        authStatusText.textContent = "Authorization Removed";
        return;
      }
    


      function uintToString(uintArray) {
        return new TextDecoder("utf-8").decode(uintArray);
      }


      document.querySelector('#file').addEventListener('change', function() {
  
    var reader = new FileReader();
    reader.onload = function() {  
      var arrayBuffer = this.result;
      array = new Uint8Array(arrayBuffer);
      window.fileContent = String.fromCharCode.apply(null, array);
      // alert(fileContent);
      // window.fileContent = arrayBuffer;  
    }
    reader.readAsArrayBuffer(this.files[0]);
  
  }, false);

function uploadfile() {
  window.safeApp.getContainer(auth, Container)
    .then((mdHandle) => {
      window.safeMutableData.newMutation(auth)
        .then((mutationHandle) =>
          window.safeMutableDataMutation.insert(mutationHandle, file.files[0].name, fileContent)
          .then(() =>
            window.safeMutableData.applyEntriesMutation(mdHandle, mutationHandle))
          .then(() =>
            alert('File Uploaded Successfully')));
      // console.log('New entry was inserted in the MutableData and committed to the network')));
      // window.safeMutableDataMutation.free(mutationHandle);
      // window.safeMutableData.free(mdHandle);
    }, (err) => {
      console.error(err);
      alert(err);
    });
}



      function showfiles() {
        $("#div-files").html("");
        window.safeApp.getContainer(auth, Container)
          .then((mdHandle) => {
            //can be used for identifing the Container but is mot needed here
            // window.safeMutableData.getNameAndTag(mdHandle)
            //   .then((data) =>
            // console.log(data));

            window.safeMutableData.getEntries(mdHandle)
              .then((entriesHandle) => {
                
                window.safeMutableDataEntries.forEach(entriesHandle,
                  (key, value) => {
                    // console.log('Entry Handle: ', entriesHandle);
                    console.log('File found: ', uintToString(key));
                    // console.log('Value: ', uintToString(value.buf));
                    // console.log(key, value);

                    $("#div-files").append("<p class='filedirnames'>" + uintToString(key) + "</p>");
                  });
                  
                // window.safeMutableDataEntries.free(entriesHandle);
                // window.safeMutableData.free(mdHandle);
              });
          }, (err) => {
            console.error(err);
            // Materialize.toast(err, 3000, 'rounded');
          });
      }
    
</script>
</body>
</html>
