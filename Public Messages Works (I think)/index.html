<!DOCTYPE html>
<html>

<head>
  <title>BabySAFE API</title>
</head>

<body>

  <h1>BabySAFE API</h1>

  <div style="float:left;margin:40px;">
    <h2>Authorize</h2>
    <input type="submit" value="AUTHORIZE" onclick="auth()" />&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<button>CHECK AUTHORIZATION</button><br><br><button>REMOVE AUTHORIZATION (Logout)</button><br><br>
    <b>Authorization Status Appears Here</b>
    <script>
    function auth() {
	window.safeApp
		.initialise(
			{
				id: 'will',
				name: 'WebApp Test',
				vendor: 'MaidSafe Ltd.'
			},
			newState => {
				console.log('Network state changed to: ', newState);
			}
		)
		.then(appHandle => {
			console.log('SAFEApp instance initialised and handle returned: ', appHandle);

			window.safeApp
				.authorise(
					appHandle, // the app handle obtained when invoking `initialise`
					{
						_public: ['Insert'] // request to insert into `_public` container
					},
					{ own_container: true } // and we want our own container, too
				)
				.then(authUri => window.safeApp.connectAuthorised(appHandle, authUri))
				.then(authorisedAppHandle => {
					auth = authorisedAppHandle;
					console.log('The app was authorised & a session was created with the network');
					getMessages();
				});
		});
}

function getMessages() {
	var name = 'BabySAFEapi';
	document.getElementById('messages').innerHTML = '';
	window.safeCrypto
		.sha3Hash(auth, name)
		.then(hash => window.safeMutableData.newPublic(auth, hash, 04112017))
		.then(mdHandle => {
			window.safeMutableData.getEntries(mdHandle).then(
				entriesHandle => {
					window.safeMutableDataEntries.forEach(entriesHandle, (key, value) => {
						var el = document.getElementById('messages');
						var elChild = document.createElement('li');
						elChild.innerHTML = value.buf.toString();
						el.appendChild(elChild);
					});
					window.safeMutableDataEntries.free(entriesHandle);
					window.safeMutableData.free(mdHandle);
				},
				err => {
					console.error(err);
				}
			);
		});
}

function sendMessage() {
	var name = 'BabySAFEapi';
	window.safeCrypto
		.sha3Hash(auth, name)
		.then(hash => window.safeMutableData.newPublic(auth, hash, 04112017))
		.then(mdHandle => {
			window.safeMutableData.newMutation(auth).then(mutationHandle => {
				var time = new Date().getTime();
				window.safeMutableDataMutation
					.insert(mutationHandle, time.toString(), textarea.value)
					.then(_ => window.safeMutableData.applyEntriesMutation(mdHandle, mutationHandle))
					.then(_ => {
						window.safeMutableDataMutation.free(mutationHandle);
						window.safeMutableData.free(mdHandle);
						getMessages();
					});
				textarea.value = '';
			});
		});
}
</script>
  </div>

  <div style="float:left;margin:40px;">
    <h2>Uploading Files</h2>
    <h3>Upload Public File</h3>
    <input type="file" /><br><br><button>UPLOAD FILE</button><br><br>
    <h3>Upload Private File</h3>
    <input type="file" /><br><br><button>UPLOAD FILE</button><br><br>
    <h3>Upload Text String</h3>
    <input type="text" value="Enter String..." size="11" /><br><br><button>UPLOAD TEXT STRING</button><br><br>
  </div>

  <div style="float:left;margin:40px;">
    <h2>Display Uploaded Files</h2> Displays <b>Images, Video, Audio,<br> Text Strings, & maybe Documents?</b><br><br>
    <button>Click to Display Files</button><br>
  </div>

  <div style="float:left;margin:40px;">
    <h2>Messages (Text)</h2>

    <h3>Private Message</h3>
    <input type="text" placeholder="Enter Message..." size="13" /> <input type="text" placeholder="Enter Recipient's ID..." size="17" /> <input type="submit" value="Send Message" /><br><br>
    <b>RECEIVED MESSAGES SHOW UP HERE</b><br><br>
    <h3>General, public chatroom message</h3>
    <input id="textarea" type="text" placeholder="Enter Message..." size="13" /> <input type="submit" value="Send Message" onclick="sendMessage()" /><br><br>
    <b>ALL PUBLIC MESSAGES SHOW UP HERE</b>
    <ul id="messages">
    </ul>
  </div>



  <div style="float:left;margin:40px;">
    <h2>File Operations (NFS)</h2>
    <h3>Create Folder</h3>
    <input type="text" placeholder="Enter Folder Name..." /> <input type="submit" value="Create Folder" /><br><br>
    <h4>Create ID</h4>
    <input type="text" placeholder="Enter Desired ID..." /> <input type="submit" value="Claim ID" /><br><br>
    <h4>Create URL</h4>
    <input type="text" placeholder="Enter Desired URL..." /> <input type="submit" value="Map the URL..." /><br><br>
  </div>

  <br><br><br>
</body>

</html>
